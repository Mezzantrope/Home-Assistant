daylight:
  # ===================================================================
  # DAYLIGHT ANALYSIS PACKAGE
  # ===================================================================
  # –°–∏—Å—Ç–µ–º–∞ –∞–Ω–∞–ª–∏–∑–∞ —É–ª–∏—á–Ω–æ–≥–æ –æ—Å–≤–µ—â–µ–Ω–∏—è –∏ –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏ –¥–Ω—è
  #
  # –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
  # 1. –°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ —Å –≤–æ—Å—Ö–æ–¥–∞+1—á –¥–æ –∑–∞—Ö–æ–¥–∞-1—á
  # 2. –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ—Ç —Å—Ä–µ–¥–Ω–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∑–∞ –¥–µ–Ω—å
  # 3. –ü—Ä–∏ –∑–∞—Ö–æ–¥–µ —Å–æ–ª–Ω—Ü–∞ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –≤ Telegram
  #
  # –£—Å—Ç–∞–Ω–æ–≤–∫–∞:
  # 1. –°–æ–∑–¥–∞–π—Ç–µ —Ñ–∞–π–ª: config/packages/daylight_analysis.yaml
  # 2. –ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–µ Home Assistant
  # ===================================================================

  # -------------------------------------------------------------------
  # MQTT Sensors (—Å—á—ë—Ç—á–∏–∫–∏ –¥–Ω–µ–π –ø–æ —Ç–∏–ø–∞–º)
  # -------------------------------------------------------------------

  mqtt:
    sensor:
      - name: "Daylight Sunny Days Count"
        state_topic: "daylight/sunny_days"
        icon: mdi:weather-sunny
        unit_of_measurement: "–¥–Ω"

      - name: "Daylight Cloudy Days Count"
        state_topic: "daylight/cloudy_days"
        icon: mdi:weather-partly-cloudy
        unit_of_measurement: "–¥–Ω"

      - name: "Daylight Overcast Days Count"
        state_topic: "daylight/overcast_days"
        icon: mdi:weather-cloudy
        unit_of_measurement: "–¥–Ω"

  # -------------------------------------------------------------------
  # Input Number (–¥–ª—è —Ö—Ä–∞–Ω–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏)
  # -------------------------------------------------------------------
  input_number:
    daylight_sum:
      name: "Daylight Sum"
      min: 0
      max: 99999999
      step: 1
      mode: box
      icon: mdi:sigma

    daylight_count:
      name: "Daylight Count"
      min: 0
      max: 10000
      step: 1
      mode: box
      icon: mdi:counter

    daylight_average:
      name: "Daylight Average"
      min: 0
      max: 100000
      step: 0.1
      mode: box
      unit_of_measurement: "lx"
      icon: mdi:weather-sunny

  # -------------------------------------------------------------------
  # Input Boolean (—Ñ–ª–∞–≥–∏ —Å–æ—Å—Ç–æ—è–Ω–∏—è)
  # -------------------------------------------------------------------
  input_boolean:
    daylight_tracking_active:
      name: "Daylight Tracking Active"
      icon: mdi:chart-line
      initial: false

    daylight_report_sent:
      name: "Daylight Report Sent Today"
      icon: mdi:email-check
      initial: false

  # -------------------------------------------------------------------
  # Template Sensors (–≤—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ –¥–∞—Ç—á–∏–∫–∏)
  # -------------------------------------------------------------------
  template:
    - sensor:
        # –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
        - name: "Daylight Tracking Status"
          unique_id: daylight_tracking_status
          icon: mdi:information-outline
          state: >
            {% if is_state('input_boolean.daylight_tracking_active', 'on') %}
              –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–µ–Ω
            {% elif is_state('input_boolean.daylight_report_sent', 'on') %}
              –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
            {% else %}
              –û–∂–∏–¥–∞–Ω–∏–µ —Ä–∞—Å—Å–≤–µ—Ç–∞
            {% endif %}
          attributes:
            samples_collected: "{{ states('input_number.daylight_count') | int }}"
            current_sum: "{{ states('input_number.daylight_sum') | float | round(0) }}"
            current_average: "{{ states('input_number.daylight_average') | float | round(1) }}"

        # –ö–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–Ω—è –ø–æ —Ç–µ–∫—É—â–µ–º—É —Å—Ä–µ–¥–Ω–µ–º—É
        - name: "Day Type Classification"
          unique_id: day_type_classification
          icon: >
            {% set avg = states('input_number.daylight_average') | float %}
            {% if avg >= 5000 %}mdi:weather-sunny
            {% elif avg >= 2000 %}mdi:weather-partly-cloudy
            {% else %}mdi:weather-cloudy
            {% endif %}
          state: >
            {% set avg = states('input_number.daylight_average') | float %}
            {% if avg >= 5000 %}
              –°–æ–ª–Ω–µ—á–Ω—ã–π –¥–µ–Ω—å
            {% elif avg >= 2000 %}
              –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å
            {% else %}
              –ü–∞—Å–º—É—Ä–Ω—ã–π –¥–µ–Ω—å
            {% endif %}
          attributes:
            average_lux: "{{ states('input_number.daylight_average') | float | round(1) }}"
            threshold_sunny: 5000
            threshold_cloudy: 2000

        # –¢–µ–∫—É—â–∞—è –º–µ—Å—è—á–Ω–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞
        - name: "Daylight Monthly Statistics"
          unique_id: daylight_monthly_statistics
          icon: mdi:calendar-month
          state: >
            {{ states('sensor.daylight_sunny_days_count') | int(0) + 
               states('sensor.daylight_cloudy_days_count') | int(0) + 
               states('sensor.daylight_overcast_days_count') | int(0) }}
          attributes:
            sunny_days: "{{ states('sensor.daylight_sunny_days_count') | int(0) }}"
            cloudy_days: "{{ states('sensor.daylight_cloudy_days_count') | int(0) }}"
            overcast_days: "{{ states('sensor.daylight_overcast_days_count') | int(0) }}"
            total_days: >
              {{ states('sensor.daylight_sunny_days_count') | int(0) + 
                 states('sensor.daylight_cloudy_days_count') | int(0) + 
                 states('sensor.daylight_overcast_days_count') | int(0) }}
            month: "{{ now().strftime('%B %Y') }}"
            sunny_percentage: >
              {% set total = states('sensor.daylight_sunny_days_count') | int(0) + 
                             states('sensor.daylight_cloudy_days_count') | int(0) + 
                             states('sensor.daylight_overcast_days_count') | int(0) %}
              {% if total > 0 %}
                {{ ((states('sensor.daylight_sunny_days_count') | int(0) / total) * 100) | round(1) }}
              {% else %}
                0
              {% endif %}

  # -------------------------------------------------------------------
  # Automation (–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü–∏–∏)
  # -------------------------------------------------------------------
  automation:
    # 1. –ù–ê–ß–ê–õ–û –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø (–≤–æ—Å—Ö–æ–¥ + 1 —á–∞—Å)
    # -----------------------------------------------------------------
    - id: "daylight_start_tracking"
      alias: "–û—Å–≤–µ—â–µ–Ω–∏–µ: –ù–∞—á–∞–ª–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è"
      description: "–ù–∞—á–∏–Ω–∞–µ—Ç —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö —á–µ—Ä–µ–∑ 1 —á–∞—Å –ø–æ—Å–ª–µ –≤–æ—Å—Ö–æ–¥–∞"

      trigger:
        - platform: sun
          event: sunrise
          offset: "+01:00:00"

      action:
        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫–∏
        - service: input_number.set_value
          target:
            entity_id: input_number.daylight_sum
          data:
            value: 0

        - service: input_number.set_value
          target:
            entity_id: input_number.daylight_count
          data:
            value: 0

        - service: input_number.set_value
          target:
            entity_id: input_number.daylight_average
          data:
            value: 0

        # –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
        - service: input_boolean.turn_on
          target:
            entity_id: input_boolean.daylight_tracking_active

        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–ª–∞–≥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á—ë—Ç–∞
        - service: input_boolean.turn_off
          target:
            entity_id: input_boolean.daylight_report_sent

        - service: logbook.log
          data:
            name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
            message: "‚òÄÔ∏è –ù–∞—á–∞–ª–æ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ (–≤–æ—Å—Ö–æ–¥ + 1—á)"

    # 2. –°–ë–û–† –î–ê–ù–ù–´–• (–∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç)
    # -----------------------------------------------------------------
    - id: "daylight_collect_data"
      alias: "–û—Å–≤–µ—â–µ–Ω–∏–µ: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö"
      description: "–°–æ–±–∏—Ä–∞–µ—Ç –¥–∞–Ω–Ω—ã–µ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç"

      trigger:
        - platform: time_pattern
          minutes: "/5" # –ö–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç

      condition:
        # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
        - condition: state
          entity_id: input_boolean.daylight_tracking_active
          state: "on"

        # –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–µ—Ä–∏–æ–¥: –ø–æ—Å–ª–µ –≤–æ—Å—Ö–æ–¥–∞+1—á –∏ –¥–æ –∑–∞–∫–∞—Ç–∞-1—á
        - condition: sun
          after: sunrise
          after_offset: "+01:00:00"

        - condition: sun
          before: sunset
          before_offset: "-01:00:00"

        # –î–∞—Ç—á–∏–∫ –¥–æ—Å—Ç—É–ø–µ–Ω
        - condition: template
          value_template: "{{ states('sensor.esphome_web_da9c3e_tcs34725_illuminance') not in ['unavailable', 'unknown'] }}"

      action:
        - variables:
            current_lux: "{{ states('sensor.esphome_web_da9c3e_tcs34725_illuminance') | float(0) }}"
            current_sum: "{{ states('input_number.daylight_sum') | float(0) }}"
            current_count: "{{ states('input_number.daylight_count') | int(0) }}"

        # –î–æ–±–∞–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ –∫ —Å—É–º–º–µ
        - service: input_number.set_value
          target:
            entity_id: input_number.daylight_sum
          data:
            value: "{{ current_sum + current_lux }}"

        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å—á—ë—Ç—á–∏–∫ –∏–∑–º–µ—Ä–µ–Ω–∏–π
        - service: input_number.set_value
          target:
            entity_id: input_number.daylight_count
          data:
            value: "{{ current_count + 1 }}"

        # –†–∞—Å—Å—á–∏—Ç—ã–≤–∞–µ–º —Å—Ä–µ–¥–Ω–µ–µ
        - service: input_number.set_value
          target:
            entity_id: input_number.daylight_average
          data:
            value: >
              {% set new_count = current_count + 1 %}
              {% set new_sum = current_sum + current_lux %}
              {% if new_count > 0 %}
                {{ (new_sum / new_count) | round(1) }}
              {% else %}
                0
              {% endif %}

    # 3. –û–°–¢–ê–ù–û–í–ö–ê –û–¢–°–õ–ï–ñ–ò–í–ê–ù–ò–Ø (–∑–∞–∫–∞—Ç - 1 —á–∞—Å)
    # -----------------------------------------------------------------
    - id: "daylight_stop_tracking"
      alias: "–û—Å–≤–µ—â–µ–Ω–∏–µ: –û—Å—Ç–∞–Ω–æ–≤–∫–∞ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è"
      description: "–û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∑–∞ 1 —á–∞—Å –¥–æ –∑–∞–∫–∞—Ç–∞"

      trigger:
        - platform: sun
          event: sunset
          offset: "-01:00:00"

      condition:
        - condition: state
          entity_id: input_boolean.daylight_tracking_active
          state: "on"

      action:
        # –î–µ–∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ
        - service: input_boolean.turn_off
          target:
            entity_id: input_boolean.daylight_tracking_active

        - service: logbook.log
          data:
            name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
            message: >
              üåÖ –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∑–∞–≤–µ—Ä—à–µ–Ω–æ. –°–æ–±—Ä–∞–Ω–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π: {{ states('input_number.daylight_count') | int }}

    # 4. –û–¢–ü–†–ê–í–ö–ê –û–¢–ß–Å–¢–ê (–≤–æ –≤—Ä–µ–º—è –∑–∞–∫–∞—Ç–∞)
    # -----------------------------------------------------------------
    - id: "daylight_send_report"
      alias: "–£–í–î: –û—Å–≤–µ—â–µ–Ω–∏–µ: –û—Ç–ø—Ä–∞–≤–∫–∞ –æ—Ç—á—ë—Ç–∞"
      description: "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –æ—Ç—á—ë—Ç –æ –¥–Ω–µ –≤–æ –≤—Ä–µ–º—è –∑–∞–∫–∞—Ç–∞"

      trigger:
        - platform: sun
          event: sunset

      condition:
        # –û—Ç—á—ë—Ç –µ—â—ë –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        - condition: state
          entity_id: input_boolean.daylight_report_sent
          state: "off"

        # –ï—Å—Ç—å —Å–æ–±—Ä–∞–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ
        - condition: template
          value_template: "{{ states('input_number.daylight_count') | int > 0 }}"

      action:
        - variables:
            avg_lux: "{{ states('input_number.daylight_average') | float | round(1) }}"
            samples: "{{ states('input_number.daylight_count') | int }}"

        - service: telegram_bot.send_message
          data:
            config_entry_id: !secret telegram_entry_id_info
            title: "üåÖ –û–¢–ß–Å–¢ –û –î–ù–ï–í–ù–û–ú –û–°–í–ï–©–ï–ù–ò–ò"
            message: |
              {% set avg = states('input_number.daylight_average') | float %}
              {% set count = states('input_number.daylight_count') | int %}
              {% set sunrise_time = state_attr('sun.sun', 'next_rising') %}
              {% set sunset_time = state_attr('sun.sun', 'next_setting') %}
              üìÖ –î–∞—Ç–∞: {{ now().strftime('%d.%m.%Y') }}

              {% if avg >= 5000 %}
              ‚òÄÔ∏è **–°–û–õ–ù–ï–ß–ù–´–ô –î–ï–ù–¨**
              {% elif avg >= 2000 %}
              ‚õÖ **–ü–ï–†–ï–ú–ï–ù–ù–ê–Ø –û–ë–õ–ê–ß–ù–û–°–¢–¨**
              {% else %}
              ‚òÅÔ∏è **–ü–ê–°–ú–£–†–ù–´–ô –î–ï–ù–¨**
              {% endif %}

              üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞:
              ‚Ä¢ –°—Ä–µ–¥–Ω—è—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å: {{ avg | round(1) }} lx
              ‚Ä¢ –°–æ–±—Ä–∞–Ω–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π: {{ count }}
              ‚Ä¢ –ü–µ—Ä–∏–æ–¥ –∏–∑–º–µ—Ä–µ–Ω–∏–π: {{ (count * 5) }} –º–∏–Ω—É—Ç

              üåÑ –†–∞—Å—Å–≤–µ—Ç: {{ as_timestamp(sunrise_time) | timestamp_custom('%H:%M') }}
              üåÖ –ó–∞–∫–∞—Ç: {{ now().strftime('%H:%M') }}
            target:
              - !secret chat_serv

        # –ü–æ–º–µ—á–∞–µ–º, —á—Ç–æ –æ—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω
        - service: input_boolean.turn_on
          target:
            entity_id: input_boolean.daylight_report_sent

        - service: logbook.log
          data:
            name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
            message: >
              üìß –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –°—Ä–µ–¥–Ω—è—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å: {{ states('input_number.daylight_average') | float | round(1) }} lx

    # 5. –ü–†–û–í–ï–†–ö–ê –î–û–°–¢–£–ü–ù–û–°–¢–ò –î–ê–¢–ß–ò–ö–ê
    # -----------------------------------------------------------------
    - id: "daylight_sensor_unavailable"
      alias: "–ò–ù–§: –û—Å–≤–µ—â–µ–Ω–∏–µ: –î–∞—Ç—á–∏–∫ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω"
      description: "–£–≤–µ–¥–æ–º–ª—è–µ—Ç –æ –ø—Ä–æ–±–ª–µ–º–∞—Ö —Å –¥–∞—Ç—á–∏–∫–æ–º –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏"

      trigger:
        - platform: state
          entity_id: sensor.esphome_web_da9c3e_tcs34725_illuminance
          to:
            - "unavailable"
            - "unknown"
          for:
            minutes: 15

      condition:
        # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
        - condition: state
          entity_id: input_boolean.daylight_tracking_active
          state: "on"

      action:
        - service: telegram_bot.send_message
          data:
            config_entry_id: !secret telegram_entry_id_info
            title: "‚ö†Ô∏è –ü–†–û–ë–õ–ï–ú–ê –° –î–ê–¢–ß–ò–ö–û–ú –û–°–í–ï–©–Å–ù–ù–û–°–¢–ò"
            message: >-
              üö® –î–∞—Ç—á–∏–∫ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω!

              üìç –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: TCS34725 Illuminance Sensor
              üìä –°—Ç–∞—Ç—É—Å: {{ states('sensor.esphome_web_da9c3e_tcs34725_illuminance') }}
              ‚è∞ –í—Ä–µ–º—è: {{ now().strftime('%d.%m.%Y %H:%M:%S') }}

              üìà –°–æ–±—Ä–∞–Ω–æ –∏–∑–º–µ—Ä–µ–Ω–∏–π –¥–æ —Å–±–æ—è: {{ states('input_number.daylight_count') | int }}

              ‚ö° –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–ø–æ–ª–Ω—ã–º —Å–µ–≥–æ–¥–Ω—è.
            target:
              - !secret chat_info

        - service: logbook.log
          data:
            name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
            message: "‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –î–∞—Ç—á–∏–∫ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω –≤–æ –≤—Ä–µ–º—è –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è"

    # 6. –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù–ò–ï –î–ê–¢–ß–ò–ö–ê
    # -----------------------------------------------------------------
    - id: "daylight_sensor_restored"
      alias: "–£–í–î: –û—Å–≤–µ—â–µ–Ω–∏–µ: –î–∞—Ç—á–∏–∫ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"
      description: "–£–≤–µ–¥–æ–º–ª—è–µ—Ç –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏ –¥–∞—Ç—á–∏–∫–∞"

      trigger:
        - platform: state
          entity_id: sensor.esphome_web_da9c3e_tcs34725_illuminance
          from:
            - "unavailable"
            - "unknown"

      condition:
        # –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω–æ
        - condition: state
          entity_id: input_boolean.daylight_tracking_active
          state: "on"

        # –ò –Ω–æ–≤–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –≤–∞–ª–∏–¥–Ω–æ
        - condition: template
          value_template: "{{ states('sensor.esphome_web_da9c3e_tcs34725_illuminance') not in ['unavailable', 'unknown'] }}"

      action:
        - service: telegram_bot.send_message
          data:
            config_entry_id: !secret telegram_entry_id_info
            title: "‚úÖ –î–ê–¢–ß–ò–ö –û–°–í–ï–©–Å–ù–ù–û–°–¢–ò –í–û–°–°–¢–ê–ù–û–í–õ–ï–ù"
            message: >-
              ‚úÖ –î–∞—Ç—á–∏–∫ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ —Å–Ω–æ–≤–∞ —Ä–∞–±–æ—Ç–∞–µ—Ç!

              üìç –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ: TCS34725 Illuminance Sensor
              üìä –¢–µ–∫—É—â–µ–µ –∑–Ω–∞—á–µ–Ω–∏–µ: {{ states('sensor.esphome_web_da9c3e_tcs34725_illuminance') }} lx
              ‚è∞ –í—Ä–µ–º—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è: {{ now().strftime('%H:%M:%S') }}

              ‚ö° –û—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏–µ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–æ.
            target:
              - !secret chat_info
        - service: logbook.log
          data:
            name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
            message: "‚úÖ –î–∞—Ç—á–∏–∫ –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω"

    # 7. –ù–ê–ö–û–ü–õ–ï–ù–ò–ï –°–¢–ê–¢–ò–°–¢–ò–ö–ò –ü–û –¢–ò–ü–ê–ú –î–ù–ï–ô
    # -----------------------------------------------------------------
    - id: "daylight_accumulate_day_type"
      alias: "–û—Å–≤–µ—â–µ–Ω–∏–µ: –ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –º–µ—Å—è—á–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏"
      description: "–ù–∞–∫–∞–ø–ª–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–Ω–µ–π –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞ –≤ MQTT"

      trigger:
        - platform: state
          entity_id: input_boolean.daylight_report_sent
          to: "on"

      condition:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –µ—Å—Ç—å –≤–∞–ª–∏–¥–Ω–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è
        - condition: template
          value_template: "{{ states('sensor.day_type_classification') not in ['unavailable', 'unknown'] }}"

      action:
        - variables:
            day_type: "{{ states('sensor.day_type_classification') }}"
            current_sunny: "{{ states('sensor.daylight_sunny_days_count') | int(0) }}"
            current_cloudy: "{{ states('sensor.daylight_cloudy_days_count') | int(0) }}"
            current_overcast: "{{ states('sensor.daylight_overcast_days_count') | int(0) }}"

        # –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–π —Å—á—ë—Ç—á–∏–∫ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ –¥–Ω—è
        - choose:
            # –°–æ–ª–Ω–µ—á–Ω—ã–π –¥–µ–Ω—å
            - conditions:
                - condition: template
                  value_template: "{{ day_type == '–°–æ–ª–Ω–µ—á–Ω—ã–π –¥–µ–Ω—å' }}"
              sequence:
                - service: mqtt.publish
                  data:
                    topic: "daylight/sunny_days"
                    payload: "{{ current_sunny + 1 }}"
                    retain: true

                - service: logbook.log
                  data:
                    name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
                    message: "‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω—ã–π –¥–µ–Ω—å –∑–∞–ø–∏—Å–∞–Ω. –í—Å–µ–≥–æ –∑–∞ –º–µ—Å—è—Ü: {{ current_sunny + 1 }}"

            # –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å
            - conditions:
                - condition: template
                  value_template: "{{ day_type == '–ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å' }}"
              sequence:
                - service: mqtt.publish
                  data:
                    topic: "daylight/cloudy_days"
                    payload: "{{ current_cloudy + 1 }}"
                    retain: true

                - service: logbook.log
                  data:
                    name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
                    message: "‚õÖ –î–µ–Ω—å —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–±–ª–∞—á–Ω–æ—Å—Ç—å—é –∑–∞–ø–∏—Å–∞–Ω. –í—Å–µ–≥–æ –∑–∞ –º–µ—Å—è—Ü: {{ current_cloudy + 1 }}"

            # –ü–∞—Å–º—É—Ä–Ω—ã–π –¥–µ–Ω—å
            - conditions:
                - condition: template
                  value_template: "{{ day_type == '–ü–∞—Å–º—É—Ä–Ω—ã–π –¥–µ–Ω—å' }}"
              sequence:
                - service: mqtt.publish
                  data:
                    topic: "daylight/overcast_days"
                    payload: "{{ current_overcast + 1 }}"
                    retain: true

                - service: logbook.log
                  data:
                    name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
                    message: "‚òÅÔ∏è –ü–∞—Å–º—É—Ä–Ω—ã–π –¥–µ–Ω—å –∑–∞–ø–∏—Å–∞–Ω. –í—Å–µ–≥–æ –∑–∞ –º–µ—Å—è—Ü: {{ current_overcast + 1 }}"

    # 8. –ú–ï–°–Ø–ß–ù–´–ô –û–¢–ß–Å–¢ –ò –°–ë–†–û–° –°–¢–ê–¢–ò–°–¢–ò–ö–ò
    # -----------------------------------------------------------------
    - id: "daylight_monthly_report"
      alias: "–£–í–î: –û—Å–≤–µ—â–µ–Ω–∏–µ: –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç"
      description: "–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–≤–æ–¥–∫—É –∑–∞ –º–µ—Å—è—Ü –∏ —Å–±—Ä–∞—Å—ã–≤–∞–µ—Ç —Å—á—ë—Ç—á–∏–∫–∏"

      trigger:
        - platform: time
          at: "09:00:00" # –í—Ä–µ–º—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç—á—ë—Ç–∞

      condition:
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ–≥–æ–¥–Ω—è 1-–µ —á–∏—Å–ª–æ
        - condition: template
          value_template: "{{ now().day == 1 }}"

      action:
        - variables:
            sunny_count: "{{ states('sensor.daylight_sunny_days_count') | int(0) }}"
            cloudy_count: "{{ states('sensor.daylight_cloudy_days_count') | int(0) }}"
            overcast_count: "{{ states('sensor.daylight_overcast_days_count') | int(0) }}"
            total_days: "{{ sunny_count | int + cloudy_count | int + overcast_count | int }}"
            prev_month: "{{ (now() - timedelta(days=1)).strftime('%B %Y') }}"
            prev_month_ru: >
              {% set month = (now() - timedelta(days=1)).month %}
              {% set months = {
                1: '–Ø–Ω–≤–∞—Ä—å', 2: '–§–µ–≤—Ä–∞–ª—å', 3: '–ú–∞—Ä—Ç', 4: '–ê–ø—Ä–µ–ª—å',
                5: '–ú–∞–π', 6: '–ò—é–Ω—å', 7: '–ò—é–ª—å', 8: '–ê–≤–≥—É—Å—Ç',
                9: '–°–µ–Ω—Ç—è–±—Ä—å', 10: '–û–∫—Ç—è–±—Ä—å', 11: '–ù–æ—è–±—Ä—å', 12: '–î–µ–∫–∞–±—Ä—å'
              } %}
              {{ months[month] }}

        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –º–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç
        - service: telegram_bot.send_message
          data:
            config_entry_id: !secret telegram_entry_id_info
            title: "üìä –ú–ï–°–Ø–ß–ù–ê–Ø –°–¢–ê–¢–ò–°–¢–ò–ö–ê –û–°–í–ï–©–ï–ù–ò–Ø"
            message: |
              üìÖ –û—Ç—á—ë—Ç –∑–∞ {{ prev_month_ru }} {{ (now() - timedelta(days=1)).year }}

              üå§Ô∏è –ü–æ–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è –∑–∞ –º–µ—Å—è—Ü:

              ‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω—ã—Ö –¥–Ω–µ–π: {{ sunny_count }}
              {% if total_days > 0 %}({{ ((sunny_count / total_days) * 100) | round(0) }}%){% endif %}

              ‚õÖ –î–Ω–µ–π —Å –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π –æ–±–ª–∞—á–Ω–æ—Å—Ç—å—é: {{ cloudy_count }}
              {% if total_days > 0 %}({{ ((cloudy_count / total_days) * 100) | round(0) }}%){% endif %}

              ‚òÅÔ∏è –ü–∞—Å–º—É—Ä–Ω—ã—Ö –¥–Ω–µ–π: {{ overcast_count }}
              {% if total_days > 0 %}({{ ((overcast_count / total_days) * 100) | round(0) }}%){% endif %}

              üìä –í—Å–µ–≥–æ –¥–Ω–µ–π —Å –¥–∞–Ω–Ω—ã–º–∏: {{ total_days }}

              {% if sunny_count >= cloudy_count and sunny_count >= overcast_count %}
              üèÜ –ü—Ä–µ–æ–±–ª–∞–¥–∞–ª–∏ —Å–æ–ª–Ω–µ—á–Ω—ã–µ –¥–Ω–∏!
              {% elif cloudy_count >= sunny_count and cloudy_count >= overcast_count %}
              üå•Ô∏è –ü—Ä–µ–æ–±–ª–∞–¥–∞–ª–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å
              {% else %}
              ‚õàÔ∏è –ü—Ä–µ–æ–±–ª–∞–¥–∞–ª–∏ –ø–∞—Å–º—É—Ä–Ω—ã–µ –¥–Ω–∏
              {% endif %}
            target:
              - !secret chat_serv

        - service: logbook.log
          data:
            name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
            message: |
              üìä –ú–µ—Å—è—á–Ω—ã–π –æ—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω. –°–æ–ª–Ω–µ—á–Ω—ã—Ö: {{ sunny_count }}, –û–±–ª–∞—á–Ω—ã—Ö: {{ cloudy_count }}, –ü–∞—Å–º—É—Ä–Ω—ã—Ö: {{ overcast_count }}

        # –ñ–¥—ë–º 2 —Å–µ–∫—É–Ω–¥—ã —á—Ç–æ–±—ã —Å–æ–æ–±—â–µ–Ω–∏–µ —Ç–æ—á–Ω–æ —É—à–ª–æ
        - delay:
            seconds: 2

        # –°–±—Ä–∞—Å—ã–≤–∞–µ–º –≤—Å–µ —Å—á—ë—Ç—á–∏–∫–∏ –Ω–∞ –Ω–æ–≤—ã–π –º–µ—Å—è—Ü
        - service: mqtt.publish
          data:
            topic: "daylight/sunny_days"
            payload: "0"
            retain: true

        - service: mqtt.publish
          data:
            topic: "daylight/cloudy_days"
            payload: "0"
            retain: true

        - service: mqtt.publish
          data:
            topic: "daylight/overcast_days"
            payload: "0"
            retain: true

        - service: logbook.log
          data:
            name: "–û—Å–≤–µ—â–µ–Ω–∏–µ"
            message: "üîÑ –°—á—ë—Ç—á–∏–∫–∏ –º–µ—Å—è—á–Ω–æ–π —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ —Å–±—Ä–æ—à–µ–Ω—ã"

  # ===================================================================
  # DASHBOARD –ö–ê–†–¢–û–ß–ö–ê –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞
  # ===================================================================
  # type: vertical-stack
  # cards:
  #   # –¢–µ–∫—É—â–∞—è –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏—è –¥–Ω—è
  #   - type: entities
  #     title: üå§Ô∏è –ê–Ω–∞–ª–∏–∑ –¥–Ω–µ–≤–Ω–æ–≥–æ –æ—Å–≤–µ—â–µ–Ω–∏—è
  #     entities:
  #       - entity: sensor.day_type_classification
  #         name: –¢–∏–ø –¥–Ω—è
  #       - entity: input_number.daylight_average
  #         name: –°—Ä–µ–¥–Ω—è—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å
  #       - entity: sensor.daylight_tracking_status
  #         name: –°—Ç–∞—Ç—É—Å –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è
  #       - entity: input_number.daylight_count
  #         name: –ò–∑–º–µ—Ä–µ–Ω–∏–π —Å–æ–±—Ä–∞–Ω–æ
  #       - entity: input_boolean.daylight_tracking_active
  #         name: –°–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –∞–∫—Ç–∏–≤–µ–Ω
  #       - entity: input_boolean.daylight_report_sent
  #         name: –û—Ç—á—ë—Ç –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω —Å–µ–≥–æ–¥–Ω—è
  #     state_color: true
  #
  #   # –ì—Ä–∞—Ñ–∏–∫ —Ç–µ–∫—É—â–µ–≥–æ –¥–∞—Ç—á–∏–∫–∞
  #   - type: sensor
  #     entity: sensor.esphome_web_da9c3e_tcs34725_illuminance
  #     name: –¢–µ–∫—É—â–∞—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å
  #     graph: line
  #     hours_to_show: 12
  #
  #   # –ò–Ω–¥–∏–∫–∞—Ç–æ—Ä –∫–ª–∞—Å—Å–∏—Ñ–∏–∫–∞—Ü–∏–∏
  #   - type: markdown
  #     content: >
  #       {% set avg = states('input_number.daylight_average') | float %}
  #       {% if avg >= 5000 %}
  #       ## ‚òÄÔ∏è –°–æ–ª–Ω–µ—á–Ω—ã–π –¥–µ–Ω—å
  #       –°—Ä–µ–¥–Ω—è—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å –≤—ã—à–µ 5000 lx
  #       {% elif avg >= 2000 %}
  #       ## ‚õÖ –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å
  #       –°—Ä–µ–¥–Ω—è—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å 2000-5000 lx
  #       {% else %}
  #       ## ‚òÅÔ∏è –ü–∞—Å–º—É—Ä–Ω—ã–π –¥–µ–Ω—å
  #       –°—Ä–µ–¥–Ω—è—è –æ—Å–≤–µ—â—ë–Ω–Ω–æ—Å—Ç—å –Ω–∏–∂–µ 2000 lx
  #       {% endif %}
  #
  #       ---
  #
  #       **–¢–µ–∫—É—â–µ–µ —Å—Ä–µ–¥–Ω–µ–µ:** {{ avg | round(1) }} lx
  #
  #       **–ò–∑–º–µ—Ä–µ–Ω–∏–π:** {{ states('input_number.daylight_count') | int }}

  # ===================================================================
  # –õ–û–ì–ò–ö–ê –ò –û–°–û–ë–ï–ù–ù–û–°–¢–ò –†–ê–ë–û–¢–´
  # ===================================================================
  #
  # ‚úÖ –í–†–ï–ú–ï–ù–ù–´–ï –†–ê–ú–ö–ò:
  # - –ù–∞—á–∞–ª–æ —Å–±–æ—Ä–∞: –í–æ—Å—Ö–æ–¥ + 1 —á–∞—Å
  # - –ö–æ–Ω–µ—Ü —Å–±–æ—Ä–∞: –ó–∞–∫–∞—Ç - 1 —á–∞—Å
  # - –û—Ç—á—ë—Ç: –í–æ –≤—Ä–µ–º—è —Ñ–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –∑–∞–∫–∞—Ç–∞
  #
  # ‚úÖ –°–ë–û–† –î–ê–ù–ù–´–•:
  # - –ß–∞—Å—Ç–æ—Ç–∞: –∫–∞–∂–¥—ã–µ 5 –º–∏–Ω—É—Ç
  # - –ü—Ä–∏ –æ–±–ª–∞—á–Ω–æ—Å—Ç–∏ 12 —á–∞—Å–æ–≤ = 144 –∏–∑–º–µ—Ä–µ–Ω–∏—è
  # - –ò—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–∞–∫–æ–ø–∏—Ç–µ–ª—å–Ω—É—é —Å—É–º–º—É –¥–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏
  #
  # ‚úÖ –ö–õ–ê–°–°–ò–§–ò–ö–ê–¶–ò–Ø:
  # - –°–æ–ª–Ω–µ—á–Ω—ã–π: ‚â• 5000 lx
  # - –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –æ–±–ª–∞—á–Ω–æ—Å—Ç—å: 2000-4999 lx
  # - –ü–∞—Å–º—É—Ä–Ω—ã–π: < 2000 lx
  #
  # ‚úÖ –ó–ê–©–ò–¢–ê –û–¢ –û–®–ò–ë–û–ö:
  # - –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞—Ç—á–∏–∫–∞
  # - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø—Ä–∏ —Å–±–æ—è—Ö
  # - –ò–≥–Ω–æ—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ unavailable –∑–Ω–∞—á–µ–Ω–∏–π
  # - –ï–∂–µ–¥–Ω–µ–≤–Ω—ã–π —Å–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–æ–≤
  #
  # ‚úÖ –£–í–ï–î–û–ú–õ–ï–ù–ò–Ø:
  # - –û—Ç—á—ë—Ç –≤–æ –≤—Ä–µ–º—è –∑–∞–∫–∞—Ç–∞
  # - –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –¥–∞—Ç—á–∏–∫–∞
  # - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏
  #
  # ===================================================================
