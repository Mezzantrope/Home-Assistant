leaks:
  automation:
  - id: water_leak_autoshutoff
    alias: "–ê–í–¢: –ü–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –≤–æ–¥—ã –ø—Ä–∏ —É—Ç–µ—á–∫–µ"
    mode: single
    max_exceeded: silent

    # –¢—Ä–∏–≥–≥–µ—Ä—ã: –ª—é–±–æ–π –¥–∞—Ç—á–∏–∫ –ø–µ—Ä–µ—à—ë–ª –≤ on
    trigger:
      - platform: state
        entity_id: binary_sensor.0_leak_water_leak              # –ø–æ–≥—Ä–µ–±
        to: 'on'
        for: "00:00:05"
        id: leak_cellar
      - platform: state
        entity_id: binary_sensor.0x00158d0002774dd5_water_leak_2 # –±–æ–π–ª–µ—Ä–Ω–∞—è
        to: 'on'
        for: "00:00:05"
        id: leak_boiler
      - platform: state
        entity_id: binary_sensor.0x00158d0006c5d8e0_water_leak_2 # —Ç—É–∞–ª–µ—Ç 1 —ç—Ç–∞–∂
        to: 'on'
        for: "00:00:05"
        id: leak_wc1
      - platform: state
        entity_id: binary_sensor.0x00158d00049dc8ca_water_leak_2 # –ø–æ–¥ –∫—É—Ö–Ω–µ–π
        to: 'on'
        for: "00:00:05"
        id: leak_kitchen
      - platform: state
        entity_id: binary_sensor.0x00158d000271ba87_water_leak_2 # –ø–æ–¥ —Å—Ç–∏—Ä–∞–ª–∫–æ–π
        to: 'on'
        for: "00:00:05"
        id: leak_washer
      - platform: state
        entity_id: binary_sensor.0x00158d00049e786a_water_leak_2 # –≤–∞–Ω–Ω–∞—è 2 —ç—Ç–∞–∂
        to: 'on'
        for: "00:00:05"
        id: leak_bath2
      - platform: state
        entity_id: binary_sensor.0x00158d00049e7b45_water_leak_2 # –≤–∞–Ω–Ω–∞—è 3 —ç—Ç–∞–∂
        to: 'on'
        for: "00:00:05"
        id: leak_bath3

    variables:
      press: switch.0_press
      valve: switch.0_falseleak
      # –ß–µ–ª–æ–≤–µ—á–µ—Å–∫–∏–µ –Ω–∞–∑–≤–∞–Ω–∏—è –¥–ª—è —Å–æ–æ–±—â–µ–Ω–∏—è
      leak_names:
        binary_sensor.0_leak_water_leak: "—É—Ç–µ—á–∫–∞ –≤ –ø–æ–≥—Ä–µ–±–µ"
        binary_sensor.0x00158d0002774dd5_water_leak_2: "—É—Ç–µ—á–∫–∞ –≤ –±–æ–π–ª–µ—Ä–Ω–æ–π"
        binary_sensor.0x00158d0006c5d8e0_water_leak_2: "—É—Ç–µ—á–∫–∞ –≤ —Ç—É–∞–ª–µ—Ç–µ 1 —ç—Ç–∞–∂–∞"
        binary_sensor.0x00158d00049dc8ca_water_leak_2: "—É—Ç–µ—á–∫–∞ –ø–æ–¥ –∫—É—Ö–Ω–µ–π"
        binary_sensor.0x00158d000271ba87_water_leak_2: "—É—Ç–µ—á–∫–∞ –ø–æ–¥ —Å—Ç–∏—Ä–∞–ª—å–Ω–æ–π –º–∞—à–∏–Ω–æ–π"
        binary_sensor.0x00158d00049e786a_water_leak_2: "—É—Ç–µ—á–∫–∞ –ø–æ–¥ –≤–∞–Ω–Ω–æ–π 2 —ç—Ç–∞–∂–∞"
        binary_sensor.0x00158d00049e7b45_water_leak_2: "—É—Ç–µ—á–∫–∞ –≤ –≤–∞–Ω–Ω–æ–π 3 —ç—Ç–∞–∂–∞"

    action:
      - choose:
          # –ï—Å–ª–∏ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã ‚Äî —Å–æ–æ–±—â–∞–µ–º –∏ –≤—ã—Ö–æ–¥–∏–º
          - conditions:
              - condition: template
                value_template: >
                  {{ states(press) in ['unavailable','unknown','none']
                     or states(valve) in ['unavailable','unknown','none'] }}
            sequence:
              - action: telegram_bot.send_message
                data:
                  config_entry_id: !secret telegram_entry_id
                  message: >
                    –û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ {{ leak_names.get(trigger.entity_id, trigger.entity_id) }} ({{ trigger.entity_id }}),
                    –Ω–æ –∏—Å–ø–æ–ª–Ω–∏—Ç–µ–ª—å –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω: PRESS={{ states(press) }}, VALVE={{ states(valve) }}.
                    –í–æ–¥–∞ –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∞ ‚Äî –ø—Ä–æ–≤–µ—Ä—å –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏–µ!
              - stop: "–ò—Å–ø–æ–ª–Ω–∏—Ç–µ–ª–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã"

      # 1) –°–Ω–∞—á–∞–ª–∞ –≥–ª—É—à–∏–º –Ω–∞–≥–Ω–µ—Ç–∞—Ç–µ–ª—å –¥–∞–≤–ª–µ–Ω–∏—è
      - service: switch.turn_off
        target:
          entity_id: "{{ press }}"

      # 2) –ù–∞ –≤—Å—è–∫–∏–π —Å–ª—É—á–∞–π –º–∞–ª—É—é –ø–∞—É–∑—É, —á—Ç–æ–±—ã –¥–∞–≤–ª–µ–Ω–∏–µ —É–ø–∞–ª–æ
      - delay: "00:00:02"

      # 3) –ö–æ–º–∞–Ω–¥–∞ –Ω–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∏–µ –≤–æ–¥—ã
      - service: switch.turn_on
        target:
          entity_id: "{{ valve }}"

      # 4) –£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –≤ Telegram
      - action: telegram_bot.send_message
        data:
          config_entry_id: !secret telegram_entry_id
          message: >
            üö® {{ now().strftime('%d.%m %H:%M') }} ‚Äî {{ leak_names.get(trigger.entity_id, trigger.entity_id) }}.
            –î–µ–π—Å—Ç–≤–∏—è: –Ω–∞–≥–Ω–µ—Ç–∞—Ç–µ–ª—å ‚Üí OFF, –∫–ª–∞–ø–∞–Ω Neptun ‚Üí (–≤–æ–¥–∞ –ø–µ—Ä–µ–∫—Ä—ã—Ç–∞).
